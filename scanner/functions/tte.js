function tte(e,t,r,i){let a=er(Be({protocolVersion:nC[1],maxPayload:100*1024*1024,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10},i),{createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0});if(!nC.includes(a.protocolVersion))throw new RangeError(`Unsupported protocol version: ${a.protocolVersion} (supported versions: ${nC.join(", ")})`);let n;t instanceof iC?(n=t,e._url=t.href):(n=new iC(t),e._url=t);let s=n.protocol==="ws+unix:";if(!n.host&&(!s||!n.pathname))throw new Error(`Invalid URL: ${e.url}`);let o=n.protocol==="wss:"||n.protocol==="https:",u=o?443:80,l=AIe(16).toString("base64"),p=o?DIe.get:kIe.get,c;if(a.createConnection=o?VIe:MIe,a.defaultPort=a.defaultPort||u,a.port=n.port||u,a.host=n.hostname.startsWith("[")?n.hostname.slice(1,-1):n.hostname,a.headers=Be({"Sec-WebSocket-Version":a.protocolVersion,"Sec-WebSocket-Key":l,Connection:"Upgrade",Upgrade:"websocket"},a.headers),a.path=n.pathname+n.search,a.timeout=a.handshakeTimeout,a.perMessageDeflate&&(c=new Tp(a.perMessageDeflate!==!0?a.perMessageDeflate:{},!1,a.maxPayload),a.headers["Sec-WebSocket-Extensions"]=BIe({[Tp.extensionName]:c.offer()})),r&&(a.headers["Sec-WebSocket-Protocol"]=r),a.origin&&(a.protocolVersion<13?a.headers["Sec-WebSocket-Origin"]=a.origin:a.headers.Origin=a.origin),(n.username||n.password)&&(a.auth=`${n.username}:${n.password}`),s){let d=a.path.split(":");a.socketPath=d[0],a.path=d[1]}let f=e._req=p(a);a.timeout&&f.on("timeout",()=>{tl(e,f,"Opening handshake has timed out")}),f.on("error",d=>{f===null||f.aborted||(f=e._req=null,e._readyState=Cr.CLOSING,e.emit("error",d),e.emitClose())}),f.on("response",d=>{let m=d.headers.location,h=d.statusCode;if(m&&a.followRedirects&&h>=300&&h<400){if(++e._redirects>a.maxRedirects){tl(e,f,"Maximum redirects exceeded");return}f.abort();let g=new iC(m,t);tte(e,g,r,i)}else e.emit("unexpected-response",f,d)||tl(e,f,`Unexpected server response: ${d.statusCode}`)}),f.on("upgrade",(d,m,h)=>{if(e.emit("upgrade",d),e.readyState!==Cr.CONNECTING)return;f=e._req=null;let g=IIe("sha1").update(l+FIe).digest("base64");if(d.headers["sec-websocket-accept"]!==g){tl(e,m,"Invalid Sec-WebSocket-Accept header");return}let x=d.headers["sec-websocket-protocol"],S=(r||"").split(/, */),v;if(!r&&x?v="Server sent a subprotocol but none was requested":r&&!x?v="Server sent no subprotocol":x&&!S.includes(x)&&(v="Server sent an invalid subprotocol"),v){tl(e,m,v);return}if(x&&(e._protocol=x),c)try{let b=RIe(d.headers["sec-websocket-extensions"]);b[Tp.extensionName]&&(c.accept(b[Tp.extensionName]),e._extensions[Tp.extensionName]=c)}catch{tl(e,m,"Invalid Sec-WebSocket-Extensions header");return}e.setSocket(m,h,a.maxPayload)})}