function Gae(e,t,r,n=-1){var i,a;let l=e.contentDOM.getBoundingClientRect(),s=l.top+e.viewState.paddingTop,u,{docHeight:c}=e.viewState,{x:d,y:f}=t,h=f-s;if(h<0)return 0;if(h>c)return e.state.doc.length;for(let x=e.viewState.heightOracle.textHeight/2,k=!1;u=e.elementAtHeight(h),u.type!=Ha.Text;)for(;h=n>0?u.bottom+x:u.top-x,!(h>=0&&h<=c);){if(k)return r?null:0;k=!0,n=-n}f=s+h;let p=u.from;if(p<e.viewport.from)return e.viewport.from==0?0:r?null:xL(e,l,u,d,f);if(p>e.viewport.to)return e.viewport.to==e.state.doc.length?e.state.doc.length:r?null:xL(e,l,u,d,f);let m=e.dom.ownerDocument,g=e.root.elementFromPoint?e.root:m,b=g.elementFromPoint(d,f);b&&!e.contentDOM.contains(b)&&(b=null),b||(d=Math.max(l.left+1,Math.min(l.right-1,d)),b=g.elementFromPoint(d,f),b&&!e.contentDOM.contains(b)&&(b=null));let v,y=-1;if(b&&((i=e.docView.nearest(b))===null||i===void 0?void 0:i.isEditable)!=!1){if(m.caretPositionFromPoint){let x=m.caretPositionFromPoint(d,f);x&&({offsetNode:v,offset:y}=x)}else if(m.caretRangeFromPoint){let x=m.caretRangeFromPoint(d,f);x&&({startContainer:v,startOffset:y}=x,(!e.contentDOM.contains(v)||je.safari&&j6e(v,y,d)||je.chrome&&W6e(v,y,d))&&(v=void 0))}}if(!v||!e.docView.dom.contains(v)){let x=gn.find(e.docView,p);if(!x)return h>u.top+u.height/2?u.to:u.from;({node:v,offset:y}=PD(x.dom,d,f))}let $=e.docView.nearest(v);if(!$)return null;if($.isWidget&&((a=$.dom)===null||a===void 0?void 0:a.nodeType)==1){let x=$.dom.getBoundingClientRect();return t.y<x.top||t.y<=x.bottom&&t.x<=(x.left+x.right)/2?$.posAtStart:$.posAtEnd}else return $.localPosFromDOM(v,y)+$.posAtStart}