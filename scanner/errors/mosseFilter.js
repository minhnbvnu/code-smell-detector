function mosseFilter(params){var _filter,_top,_bottom,_fft,_w,_h,_im_part,_arrlen,_cc,_image_array;this.psr_prev=void 0,this.peak_prev=void 0;var updateable=!1;if(params||(params={}),void 0===params.drawResponse)params.drawResponse=!1;else if("CANVAS"!=params.drawResponse.tagName)params.drawResponse=!1;else var responseContext=params.drawResponse.getContext("2d");void 0===params.psrThreshold&&(params.psrThreshold=10),void 0===params.eta&&(params.eta=.1),void 0===params.convertToGrayscale&&(params.convertToGrayscale=!0),this.load=function(filter){_w=filter.width,_h=filter.height,_arrlen=_w*_h,_filter=[filter.real,filter.imag],filter.top&&filter.bottom&&(updateable=!0,_top=[filter.top.real,filter.top.imag],_bottom=[filter.bottom.real,filter.bottom.imag]),(_fft=new FFT).init(filter.width),"undefined"!=typeof Float64Array?(_im_part=new Float64Array(_arrlen),_image_array=new Float64Array(_arrlen)):(_im_part=new Array(_arrlen),_image_array=new Array(_arrlen));var canvas=document.createElement("canvas");canvas.setAttribute("width",_w),canvas.setAttribute("height",_h),_cc=canvas.getContext("2d")},this.init=function(w,h){_arrlen=(_w=w)*(_h=h),_filter=[[],[]],_top=[[],[]],_bottom=[[],[]];for(var i=0;i<_arrlen;i++)_filter[0][i]=0,_filter[1][i]=0,_top[0][i]=0,_top[1][i]=0,_bottom[0][i]=0,_bottom[1][i]=0;updateable=!0,(_fft=new FFT).init(w),_im_part="undefined"!=typeof Float64Array?new Float64Array(_arrlen):new Array(_arrlen);var canvas=document.createElement("canvas");canvas.setAttribute("width",_w),canvas.setAttribute("height",_h),_cc=canvas.getContext("2d")},this.fft=function(array){for(var cn=new Array(_arrlen),i=0;i<_arrlen;i++)cn[i]=0;return _fft.fft2d(array,cn),[array,cn]},this.fft_inplace=function(array){for(var i=0;i<_arrlen;i++)_im_part[i]=0;return _fft.fft2d(array,_im_part),[array,_im_part]},this.ifft=function(rn,cn){return _fft.ifft2d(rn,cn),rn},this.psr=function(array){for(var val,sum=0,max=0,maxpos=[0,0],sdo=0,x=0;x<_w;x++)for(y=0;y<_h;y++)sum+=val=array[y*_w+x],sdo+=val*val,max<val&&(max=val,maxpos=[x,y]);for(x=-5;x<6;x++)for(var y=-5;y<6;y++)Math.sqrt(x*x+y*y)<5&&(sdo-=(val=array[(maxpos[1]+y)*_w+(maxpos[0]+x)])*val,sum-=val);var mean=sum/array.length;return(max-mean)/Math.sqrt(sdo/array.length-mean*mean)},this.getResponse=function(imageData){var prepImage=preprocess(imageData);prepImage=cosine_window(prepImage);var res=this.fft_inplace(prepImage);return complex_mult_inplace(res,_filter),this.ifft(res[0],res[1])},this.track=function(input,left,top,width,height,updateFilter,gaussianPrior,calcPSR){if(!_filter)return console.log("Mosse-filter needs to be initialized or trained before starting tracking."),!1;if("VIDEO"==input.tagName||"IMG"==input.tagName){var videoLeft=Math.round(left/input.width*input.videoWidth),videoTop=Math.round(top/input.height*input.videoHeight),videoWidth=Math.round(width/input.width*input.videoWidth),videoHeight=Math.round(height/input.height*input.videoHeight);_cc.drawImage(input,videoLeft,videoTop,videoWidth,videoHeight,0,0,_w,_h)}else"CANVAS"==input.tagName&&_cc.drawImage(input,left,top,width,height,0,0,_w,_h);var id=_cc.getImageData(0,0,_w,_h).data;if(params.convertToGrayscale)for(i=0;i<_arrlen;i++)_image_array[i]=.3*id[4*i],_image_array[i]+=.59*id[4*i+1],_image_array[i]+=.11*id[4*i+2];else for(i=0;i<_arrlen;i++)_image_array[i]=id[4*i];var prepImage=preprocess(_image_array);prepImage=cosine_window(prepImage);var res=this.fft_inplace(prepImage),nures=complex_mult(res,_filter),filtered=this.ifft(nures[0],nures[1]),max=0,min=0,maxpos=[0,0];if(gaussianPrior)for(var prior,dx,dy,x=0;x<_w;x++)for(y=0;y<_h;y++)dx=x-_w/2,dy=y-_h/2,prior=Math.exp(-.5*(dx*dx+dy*dy)/128),filtered[y*_w+x]*prior>max&&(max=filtered[y*_w+x]*prior,maxpos=[x,y]),filtered[y*_w+x]<min&&(min=filtered[y*_w+x]);else for(x=0;x<_w;x++)for(y=0;y<_h;y++)filtered[y*_w+x]>max&&(max=filtered[y*_w+x],maxpos=[x,y]),filtered[y*_w+x]<min&&(min=filtered[y*_w+x]);if(this.peak_prev=max,params.drawResponse){var diff=max-min,dc=document.createElement("canvas");dc.setAttribute("width",32),dc.setAttribute("height",32);for(var dcc=dc.getContext("2d"),psci=dcc.createImageData(32,32),pscidata=psci.data,j=0;j<1024;j++){var val=filtered[j];val=Math.round((val+Math.abs(min))*(255/diff)),pscidata[4*j]=val,pscidata[4*j+1]=val,pscidata[4*j+2]=val,pscidata[4*j+3]=255}dcc.putImageData(psci,0,0),responseContext.drawImage(dc,left,top,width,width)}if(calcPSR&&(this.psr_prev=this.psr(filtered)),updateFilter)if(updateable){if(calcPSR)psr=this.psr_prev;else var psr=this.psr(filtered);if(psr>params.psrThreshold){for(var target=[],nux=maxpos[0],nuy=maxpos[1],x=0;x<_w;x++)for(var y=0;y<_h;y++)target[y*_w+x]=Math.exp(-((x-nux)*(x-nux)+(y-nuy)*(y-nuy))/4);target=this.fft(target);for(var res_conj=complex_conj(res),fuTop=complex_mult(target,res_conj),fuBottom=complex_mult(res,res_conj),eta=params.eta,i=0;i<_arrlen;i++)_top[0][i]=eta*fuTop[0][i]+(1-eta)*_top[0][i],_top[1][i]=eta*fuTop[1][i]+(1-eta)*_top[1][i],_bottom[0][i]=eta*fuBottom[0][i]+(1-eta)*_bottom[0][i],_bottom[1][i]=eta*fuBottom[1][i]+(1-eta)*_bottom[1][i];_filter=complex_div(_top,_bottom)}}else console.log("The loaded filter does not support updating. Ignoring parameter 'updateFilter'.");return maxpos[0]=maxpos[0]*(width/_w),maxpos[1]=maxpos[1]*(width/_h),!(max<0)&&maxpos},this.train=function(input,left,top,width,height){if(!updateable)return console.log("The loaded filter does not support updating. Unable to do training."),!1;if("VIDEO"==input.tagName||"IMG"==input.tagName){var videoLeft=Math.round(left/input.width*input.videoWidth),videoTop=Math.round(top/input.height*input.videoHeight),videoWidth=Math.round(width/input.width*input.videoWidth),videoHeight=Math.round(height/input.height*input.videoHeight);_cc.drawImage(input,videoLeft,videoTop,videoWidth,videoHeight,0,0,_w,_h)}else"CANVAS"==input.tagName&&_cc.drawImage(input,left,top,width,height,0,0,_w,_h);for(var id=_cc.getImageData(0,0,_w,_h).data,i=0;i<_arrlen;i++)_image_array[i]=.3*id[4*i],_image_array[i]+=.59*id[4*i+1],_image_array[i]+=.11*id[4*i+2];var prepImage=preprocess(_image_array);prepImage=cosine_window(prepImage);for(var target=[],nux=_w/2,nuy=_h/2,x=0;x<_w;x++)for(var y=0;y<_h;y++)target[y*_w+x]=Math.exp(-((x-nux)*(x-nux)+(y-nuy)*(y-nuy))/4);target=this.fft(target);for(var res=this.fft(prepImage),res_conj=complex_conj(res),fuTop=complex_mult(target,res_conj),fuBottom=complex_mult(res,res_conj),eta=params.eta,i=0;i<_arrlen;i++)_top[0][i]=eta*fuTop[0][i]+(1-eta)*_top[0][i],_top[1][i]=eta*fuTop[1][i]+(1-eta)*_top[1][i],_bottom[0][i]=eta*fuBottom[0][i]+(1-eta)*_bottom[0][i],_bottom[1][i]=eta*fuBottom[1][i]+(1-eta)*_bottom[1][i];return _filter=complex_div(_top,_bottom),!0};var preprocess=function(array){for(i=0;i<_arrlen;i++)array[i]=Math.log(array[i]+1);for(var mean=0,i=0;i<_arrlen;i++)mean+=array[i];mean/=_arrlen;for(i=0;i<_arrlen;i++)array[i]-=mean;for(var norm=0,i=0;i<_arrlen;i++)norm+=array[i]*array[i];if(0!==(norm=Math.sqrt(norm)))for(i=0;i<_arrlen;i++)array[i]/=norm;return array},cosine_window=function(array){for(var pos=0,i=0;i<_w;i++)for(var j=0;j<_h;j++){var cww=Math.sin(Math.PI*i/(_w-1)),cwh=Math.sin(Math.PI*j/(_h-1));array[pos]=Math.min(cww,cwh)*array[pos],pos++}return array},complex_mult=function(cn1,cn2){for(var nucn=[new Array(_w),new Array(_w)],r=0;r<_arrlen;r++)nucn[0][r]=cn1[0][r]*cn2[0][r]-cn1[1][r]*cn2[1][r],nucn[1][r]=cn1[0][r]*cn2[1][r]+cn1[1][r]*cn2[0][r];return nucn},complex_mult_inplace=function(cn1,cn2){for(var temp1,temp2,r=0;r<_arrlen;r++)temp1=cn1[0][r]*cn2[0][r]-cn1[1][r]*cn2[1][r],temp2=cn1[0][r]*cn2[1][r]+cn1[1][r]*cn2[0][r],cn1[0][r]=temp1,cn1[1][r]=temp2},complex_conj=function(cn){for(var nucn=[[],[]],i=0;i<_arrlen;i++)nucn[0][i]=cn[0][i],nucn[1][i]=-cn[1][i];return nucn},complex_div=function(cn1,cn2){for(var nucn=[[],[]],r=0;r<_arrlen;r++)nucn[0][r]=(cn1[0][r]*cn2[0][r]+cn1[1][r]*cn2[1][r])/(cn2[0][r]*cn2[0][r]+cn2[1][r]*cn2[1][r]),nucn[1][r]=(cn1[1][r]*cn2[0][r]-cn1[0][r]*cn2[1][r])/(cn2[0][r]*cn2[0][r]+cn2[1][r]*cn2[1][r]);return nucn}}